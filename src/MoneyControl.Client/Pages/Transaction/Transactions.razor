@page "/"
@using System.Globalization
@using MoneyControl.Shared.Models
@inject HttpClient Http

<HeaderComponent HeaderText="Transactions"
                 ActionButtonText="Add Transaction"
                 OnClick="@AddTransactionAsync">
</HeaderComponent>

<div class="card p-2 mb-3">
    <span class="d-flex flex-wrap gap-2 pb-2">
        <label>
            <input type="checkbox" class="form-check-input" checked="@(_selectedAccounts.Count == _accounts.Count)" @onchange="@OnSelectAllAccounts"> Select All Accounts
        </label>
        @foreach (var item in _accounts)
        {
            <label>
                <input type="checkbox" class="form-check-input" checked="@_selectedAccounts.Contains(item.Id)" @onchange="@(_ => ChangeAccountsFilter(item.Id))"> @item.Name
            </label>
        }
    </span>
    
    <div class="pt-3">
        <label>Period:</label>
        <span class="d-flex py-2 gap-2">
            <input class="form-control"
                   type="date"
                   @bind="@StartDate">
            <input class="form-control"
                   type="date"
                   @bind="@EndDate">
        </span>
    </div>
    
    <span class="d-flex gap-2">
        <button @onclick="@GetFilteredTransactionsAsync" type="button" class="btn btn-primary">Apply</button>
        <button @onclick="@GetAllTransactionsAsync" type="button" class="btn btn-secondary">Reset</button>
    </span>
</div>

<div>
    <table class="table table-striped table-hover table-bordered">
        <thead>
        <tr>
            <th scope="col">Id</th>
            <th scope="col">Account Name</th>
            <th scope="col">Sum</th>
            <th scope="col">Date</th>
            <th scope="col"></th>
        </tr>
        </thead>
        <tbody class="table-group-divider">
        @foreach (var item in _transactions)
        {
            <tr scope="row">
                <th>@item.Id</th>
                <td>@item.AccountName</td>
                <td>
                    <span class="fw-bold @SumColor(item.Sum)">@(item.Sum > 0 ? "+" : string.Empty)@item.Sum</span>
                </td>
                <td>@item.DateUtc.ToString("dd.MM.yyyy", CultureInfo.InvariantCulture)</td>
                <td>
                    <span class="d-flex gap-2">
                        <button class="border-0 bg-transparent">
                            <i class="fa-solid fa-pen" @onclick="@(() => EditTransactionAsync(item))"></i>
                        </button>
                        <button class="border-0 bg-transparent">
                            <i class="fa-solid fa-trash-can text-danger" @onclick="@(() => DeleteTransactionAsync(item.Id))"></i>
                        </button>
                    </span>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@code {
    private List<AccountModel> _accounts = new();
    private List<int> _selectedAccounts = new();
    private List<TransactionModel> _transactions = new();
    [CascadingParameter] public IModalService Modal { get; set; } = default!;
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var accounts = await Http.GetFromJsonAsync<List<AccountModel>>("account");
        _accounts.Clear();

        _accounts.AddRange(accounts);
        _selectedAccounts = _accounts.Select(x => x.Id).ToList();

        _transactions = await Http.GetFromJsonAsync<List<TransactionModel>>("transaction");
    }

    private async Task GetFilteredTransactionsAsync()
    {
        var result = string.Empty;
        for (var i = 0; i < _selectedAccounts.Count; i++)
        {
            result += $"&accountids[{i}]={_selectedAccounts[i]}";
        }
        
        result += $"&startutc={StartDate?.Date}&endutc={EndDate?.Date}";

        var transactions = await Http.GetFromJsonAsync<List<TransactionModel>>($"transaction/search?{result}");
        _transactions.Clear();
        _transactions.AddRange(transactions);
    }

    private async Task GetAllTransactionsAsync()
    {
        StartDate = null;
        EndDate = null;
        
        _transactions.Clear();
        var transactions = await Http.GetFromJsonAsync<List<TransactionModel>>("transaction");
        _transactions.AddRange(transactions);
        
        _selectedAccounts.Clear();
        _selectedAccounts = _accounts.Select(x => x.Id).ToList();
    }

    private void ChangeAccountsFilter(int accountId)
    {
        if (_selectedAccounts.Contains(accountId))
        {
            _selectedAccounts.Remove(accountId);
        }
        else
        {
            _selectedAccounts.Add(accountId);
        }
    }

    private void OnSelectAllAccounts()
    {
        if (_selectedAccounts.Count == _accounts.Count)
        {
            _selectedAccounts.Clear();
        }
        else
        {
            _selectedAccounts = _accounts.Select(x => x.Id).ToList();
        }
    }

    private async Task AddTransactionAsync()
    {
        var addTransactionModel = Modal.Show<AddTransaction>("Add Transaction");
        var result = await addTransactionModel.Result;

        if (result.Cancelled)
        {
            return;
        }

        await GetFilteredTransactionsAsync();
    }

    private async Task DeleteTransactionAsync(int id)
    {
        var parameters = new ModalParameters().Add("id", id);
        var deleteTransactionModel = Modal.Show<DeleteTransaction>("Delete Transaction", parameters);
        var result = await deleteTransactionModel.Result;

        if (result.Cancelled)
        {
            return;
        }

        await GetFilteredTransactionsAsync();
    }
    
    private async Task EditTransactionAsync(TransactionModel transaction)
    {
        var copyTransaction = new TransactionModel
        {
            Id = transaction.Id,
            AccountId = transaction.AccountId,
            AccountName = transaction.AccountName,
            DateUtc = transaction.DateUtc,
            Sum = transaction.Sum
        };
        var parameters = new ModalParameters().Add("transaction", copyTransaction);
        var editTransactionModel = Modal.Show<EditTransaction>("Edit Transaction", parameters);
        var result = await editTransactionModel.Result;

        if (result.Cancelled)
        {
            return;
        }

        await GetFilteredTransactionsAsync();
    }

    private string SumColor(double sum)
    {
        return sum > 0 ? "text-success" : "text-danger";
    }
}