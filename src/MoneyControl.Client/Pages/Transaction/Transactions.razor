@page "/"
@using MoneyControl.Shared.Models
@inject HttpClient Http

<h3>Transactions</h3>

<div class="card p-2">
    <span class="d-flex flex-wrap gap-2 pb-2">
        @foreach (var item in _accounts)
        {
            <label>
                <input type="checkbox" class="form-check-input" checked="@_selectedAccounts.Contains(item.Id)" @onchange="@(_ => ChangeAccountsFilter(item.Id))"> @item.Name
            </label>
        }
    </span>
    <span class="d-flex gap-2">
        <button @onclick="@GetFilteredTransactionsAsync" type="button" class="btn btn-primary">Apply</button>
        <button @onclick="@GetAllTransactionsAsync" type="button" class="btn btn-secondary">Reset</button>
    </span>
</div>

<div class="py-2 d-flex justify-content-end">
    <button @onclick="@AddTransactionAsync" type="button" class="btn btn-primary">Add Transaction</button>
</div>

<div>
    <table class="table table-striped table-hover table-bordered">
        <thead>
        <tr>
            <th scope="col">Id</th>
            <th scope="col">AccountName</th>
            <th scope="col">Sum</th>
            <th scope="col">DateUtc</th>
            <th scope="col"></th>
        </tr>
        </thead>
        <tbody class="table-group-divider">
        @foreach (var item in _transactions)
        {
            <tr scope="row">
                <th>@item.Id</th>
                <td>@item.AccountName</td>
                <td>
                    <span class="fw-bold @SumColor(item.Sum)">@(item.Sum > 0 ? "+" : string.Empty)@item.Sum</span>
                </td>
                <td>@item.DateUtc.ToLongDateString()</td>
                <td>
                    <span class="d-flex gap-2">
                        <button class="border-0 bg-transparent">
                            <i class="fa-solid fa-pen" @onclick="@(() => EditTransactionAsync(item))"></i>
                        </button>
                        <button class="border-0 bg-transparent">
                            <i class="fa-solid fa-trash-can text-danger" @onclick="@(() => DeleteTransactionAsync(item.Id))"></i>
                        </button>
                    </span>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@code {
    private List<AccountModel> _accounts = new();
    private List<int> _selectedAccounts = new();
    private List<TransactionModel> _transactions = new();
    [CascadingParameter] public IModalService Modal { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var accounts = await Http.GetFromJsonAsync<List<AccountModel>>("account");
        _accounts.Clear();

        var selectedAccounts = _accounts.Select(x => x.Id).ToList();
        _selectedAccounts.Clear();
        _selectedAccounts.AddRange(selectedAccounts);

        _accounts.AddRange(accounts);

        _transactions = await Http.GetFromJsonAsync<List<TransactionModel>>("transaction");
    }

    private async Task GetFilteredTransactionsAsync()
    {
        var result = string.Empty;
        for (var i = 0; i < _selectedAccounts.Count; i++)
        {
            result += $"&accountids[{i}]={_selectedAccounts[i]}";
        }

        var transactions = await Http.GetFromJsonAsync<List<TransactionModel>>($"transaction/search?{result}");
        _transactions.Clear();
        _transactions.AddRange(transactions);
    }

    private async Task GetAllTransactionsAsync()
    {
        await ReloadTransactionsAsync();

        _selectedAccounts.Clear();
    }

    private void ChangeAccountsFilter(int accountId)
    {
        if (_selectedAccounts.Contains(accountId))
        {
            _selectedAccounts.Remove(accountId);
        }
        else
        {
            _selectedAccounts.Add(accountId);
        }
    }

    private async Task AddTransactionAsync()
    {
        var addTransactionModel = Modal.Show<AddTransaction>("Add Transaction");
        var result = await addTransactionModel.Result;

        if (result.Cancelled)
        {
            return;
        }

        await ReloadTransactionsAsync();
    }

    private async Task DeleteTransactionAsync(int id)
    {
        var parameters = new ModalParameters().Add("id", id);
        var deleteTransactionModel = Modal.Show<DeleteTransaction>("Delete Transaction", parameters);
        var result = await deleteTransactionModel.Result;

        if (result.Cancelled)
        {
            return;
        }

        await ReloadTransactionsAsync();
    }
    
    private async Task EditTransactionAsync(TransactionModel transaction)
    {
        var copyTransaction = new TransactionModel
        {
            Id = transaction.Id,
            AccountId = transaction.AccountId,
            AccountName = transaction.AccountName,
            DateUtc = transaction.DateUtc,
            Sum = transaction.Sum
        };
        var parameters = new ModalParameters().Add("transaction", copyTransaction);
        var editTransactionModel = Modal.Show<EditTransaction>("Edit Transaction", parameters);
        var result = await editTransactionModel.Result;

        if (result.Cancelled)
        {
            return;
        }

        await ReloadTransactionsAsync();
    }

    private async Task ReloadTransactionsAsync()
    {
        _transactions.Clear();
        var transactions = await Http.GetFromJsonAsync<List<TransactionModel>>("transaction");
        _transactions.AddRange(transactions);
    }

    private string SumColor(double sum)
    {
        return sum > 0 ? "text-success" : "text-danger";
    }
}